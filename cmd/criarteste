#!/bin/bash

echo ""
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[41m \033[37m        ⇱ SSH PLUS MANAGER - IRAN AETEAM ⇲        \033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""
function lock_user() {
    read -p "Enter username: " username
    check_user_exist=$(grep -w $username /etc/passwd | cut -d: -f1)
    if [[ $check_user_exist == $username ]]; then
        chage -E 0 $username
        echo "$username locked successfully!"
        echo "$username" >> /root/AETteam/Lock-User.txt
    else
        echo "$username not found. Please try again."
    fi
}

function unlock_user() {
    read -p "Enter username: " username
    check_user_exist=$(grep -w $username /etc/passwd | cut -d: -f1)
    if [[ $check_user_exist == $username ]]; then
        chage -E -1 $username
        echo "$username unlocked successfully!"
        sed -i "/$username/d" /root/AETteam/Lock-User.txt
    else
        echo "$username not found. Please try again."
    fi
}

function show_locked_users() {
    if [ -f "/root/AETteam/Lock-User.txt" ]; then
        echo "Locked users:"
        cat /root/AETteam/Lock-User.txt
    else
        echo "No locked users found."
    fi
}

function install_traffic_script() {
    if ! command -v vnstat &> /dev/null; then
        echo "Installing vnstat..."
        apt-get update
        apt-get install vnstat -y
    fi

    # Create and configure the traffic script
    cat > /root/AETeam/Trafic-server.sh << EOF
#!/bin/bash
VNSTAT_PATH=/usr/bin/vnstat
INTERFACE=eth0
TODAY=\$(date +"%Y-%m-%d")
TRAFFIC_FILE=/root/AETeam/Traffic.txt
VNSTAT_RESULT=\$(\$VNSTAT_PATH --json -i \$INTERFACE -m)
DOWNLOAD=\$(echo \$VNSTAT_RESULT | jq '.interfaces[].traffic.months[] | select(.date == "'\$TODAY'").rx / 1024 / 1024 / 1024')
UPLOAD=\$(echo \$VNSTAT_RESULT | jq '.interfaces[].traffic.months[] | select(.date == "'\$TODAY'").tx / 1024 / 1024 / 1024')
echo "====================" >> \$TRAFFIC_FILE
echo "DOWNLOAD: \$DOWNLOAD GB" >> \$TRAFFIC_FILE
echo "UPLOAD: \$UPLOAD GB" >> \$TRAFFIC_FILE
echo "DATE: \$TODAY" >> \$TRAFFIC_FILE
echo "====================" >> \$TRAFFIC_FILE
EOF

    # Add script execution to crontab
    (crontab -l ; echo "0 0 * * * bash /root/AETeam/Trafic-server.sh") | crontab -
    echo "Traffic script installed and configured."
}

function show_traffic_for_date() {
    read -p "Enter date (YYYY-MM-DD): " selected_date
    if grep -q "DATE: $selected_date" /root/AETeam/Traffic.txt; then
        echo "Traffic for $selected_date:"
        grep -A 3 "DATE: $selected_date" /root/AETeam/Traffic.txt
    else
        echo "No traffic data found for $selected_date."
    fi
}

echo -e "\033[1;33m           AETeam Options           \033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[0;31m===========  «\033[1;31mLOCK/UNLOCK USERS\033[0;31m»  ============\033[0m"
echo -e "\033[1;32m [1] \033[1;31m• \033[1;33mLock User\033[0m"
echo -e "\033[1;32m [2] \033[1;31m• \033[1;33mUnlock User\033[0m"
echo -e "\033[1;32m [3] \033[1;31m• \033[1;33mShow locked users\033[0m"
echo -e "\033[0;31m===========   «\033[1;31mTRAFFIC  SERVER\033[0;31m»   ============\033[0m"
echo -e "\033[1;32m [4] \033[1;31m• \033[1;33mInstall Traffic Script\033[0m"
echo -e "\033[1;32m [5] \033[1;31m• \033[1;33mShow Traffic for Date\033[0m"
echo -e "\033[0;31m===========   «\033[1;31mSPEED UP SERVER\033[0;31m»   ============\033[0m"
echo -e "\033[1;32m [X] \033[1;31m• \033[1;33mXXXXXXXXXX\033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;32m [6] \033[1;31m• \033[1;33mExit\033[0m"
echo ""
echo ""
read -p "Enter option number: " option

case $option in
1) lock_user;;
2) unlock_user;;
3) show_locked_users;;
4) install_traffic_script;;
5) show_traffic_for_date;;
6) exit;;
*) echo "Invalid option. Please try again.";;
esac
