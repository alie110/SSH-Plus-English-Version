#!/bin/bash

# Check if the directory exists, create it if not
AETEAM_DIR="/root/AETEAM"
if [ ! -d "$AETEAM_DIR" ]; then
    echo "Creating AETEAM directory..."
    mkdir -p "$AETEAM_DIR"
    echo "Directory created."

    # Create Lock-User.txt and Traffic.txt files
    touch "$AETEAM_DIR/Lock-User.txt"
    touch "$AETEAM_DIR/Traffic.txt"
    echo "Lock-User.txt and Traffic.txt created."
fi

echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[41m \033[37m        ⇱ SSH PLUS MANAGER - IRAN AETEAM ⇲        \033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""
function lock_user() {
    read -p "Enter username: " username
    check_user_exist=$(grep -w $username /etc/passwd | cut -d: -f1)
    if [[ $check_user_exist == $username ]]; then
        chage -E 0 $username
        echo "$username locked successfully!"
        echo "$username" >> "$AETEAM_DIR/Lock-User.txt"
    else
        echo "$username not found. Please try again."
    fi
}

function unlock_user() {
    read -p "Enter username: " username
    check_user_exist=$(grep -w $username /etc/passwd | cut -d: -f1)
    if [[ $check_user_exist == $username ]]; then
        chage -E -1 $username
        echo "$username unlocked successfully!"
        sed -i "/$username/d" /root/AETEAM/Lock-User.txt
    else
        echo "$username not found. Please try again."
    fi
}

function unlock_user() {
    read -p "Enter username: " username
    check_user_exist=$(grep -w $username /etc/passwd | cut -d: -f1)
    if [[ $check_user_exist == $username ]]; then
        chage -E -1 $username
        echo "$username unlocked successfully!"
        sed -i "/$username/d" "$AETEAM_DIR/Lock-User.txt"
    else
        echo "$username not found. Please try again."
    fi
}
function show_locked_users() {
    if [ -f "$AETEAM_DIR/Lock-User.txt" ]; then
        echo "Locked users:"
        cat "$AETEAM_DIR/Lock-User.txt"
    else
        echo "No locked users found."
    fi
}
#################################################################################################
function install_traffic_script() {
    if ! command -v nload &> /dev/null; then
        echo "Installing nload..."
        apt-get update
        apt-get install nload -y
    fi

    # Create and configure the traffic script
    cat > /root/AETEAM/Trafic-server.sh << EOF
#!/bin/bash
INTERFACE=eth0
TODAY=\$(date +"%d/%m/%Y")
TRAFFIC_FILE=/root/AETeam/Traffic.txt

# Get total received and transmitted bytes from ifconfig
RECEIVED=\$(ifconfig \$INTERFACE | grep 'RX bytes' | awk '{print \$2}' | cut -d ':' -f 2)
TRANSMITTED=\$(ifconfig \$INTERFACE | grep 'TX bytes' | awk '{print \$6}' | cut -d ':' -f 2)

# Convert bytes to gigabytes
RECEIVED_GB=\$(echo "\$RECEIVED / (1024 * 1024 * 1024)" | bc)
TRANSMITTED_GB=\$(echo "\$TRANSMITTED / (1024 * 1024 * 1024)" | bc)
TOTAL_GB=\$(echo "\$RECEIVED_GB + \$TRANSMITTED_GB" | bc)

echo "====================" >> \$TRAFFIC_FILE
echo "DOWNLOAD: \$RECEIVED_GB GB" >> \$TRAFFIC_FILE
echo "UPLOAD: \$TRANSMITTED_GB GB" >> \$TRAFFIC_FILE
echo "TOTAL: \$TOTAL_GB GB" >> \$TRAFFIC_FILE
echo "DATE: \$TODAY" >> \$TRAFFIC_FILE
echo "====================" >> \$TRAFFIC_FILE
EOF

    # Add script execution to crontab
    (crontab -l ; echo "0 0 * * * bash /root/AETEAM/Trafic-server.sh") | crontab -
    echo "Traffic script installed and configured."
}

function show_traffic_for_date() {
    read -p "Enter date (DD/MM/YYYY): " selected_date
    if grep -q "DATE: $selected_date" /root/AETEAM/Traffic.txt; then
        echo "Traffic for $selected_date:"
        grep -A 4 "DATE: $selected_date" /root/AETEAM/Traffic.txt
    else
        echo "No traffic data found for $selected_date."
    fi
}

# Call the install_traffic_script function to set up the script
install_traffic_script
function show_full_traffic_data() {
    if [ -f "$AETEAM_DIR/Traffic.txt" ]; then
        echo "Full Traffic Data:"
        cat "$AETEAM_DIR/Traffic.txt"
    else
        echo "No traffic data found."
    fi
}
# ... کدهای قبلی ...

# Check if the Traffic script is installed
if [ -f "$AETEAM_DIR/Trafic-server.sh" ]; then
    traffic_script_status="(INSTALLED)"
else
    traffic_script_status=""
fi

echo -e "\033[1;33m           AETeam Options           \033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[0;31m===========  «\033[1;31mLOCK/UNLOCK USERS\033[0;31m»  ============\033[0m"
echo -e "\033[1;32m [1] \033[1;31m• \033[1;33mLock User\033[0m"
echo -e "\033[1;32m [2] \033[1;31m• \033[1;33mUnlock User\033[0m"
echo -e "\033[1;32m [3] \033[1;31m• \033[1;33mShow Locked Users\033[0m"
echo -e "\033[0;31m===========   «\033[1;31mTRAFFIC  SERVER\033[0;31m»   ============\033[0m"
echo -e "\033[0;31m==================================================================\033[0m"
echo -e "\033[0;31mDOWNLOAD: \033[0m"
echo -e "\033[0;31mUPLOAD: \033[0m"
echo -e "\033[0;31mTOTAL: \033[0m"
echo -e "\033[0;31m==================================================================\033[0m"
echo -e "\033[1;32m [4] \033[1;31m• \033[1;33mInstall Traffic Script $traffic_script_status\033[0m"
echo -e "\033[1;32m [5] \033[1;31m• \033[1;33mShow Traffic for Date\033[0m"
echo -e "\033[1;32m [6] \033[1;31m• \033[1;33mShow Full Traffic\033[0m"
echo -e "\033[0;31m===========   «\033[1;31mSPEED UP SERVER\033[0;31m»   ============\033[0m"
echo -e "\033[1;32m [X] \033[1;31m• \033[1;33mXXXXXXXXXX\033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;32m [7] \033[1;31m• \033[1;33mExit\033[0m"
echo ""
echo ""
read -p "Enter option number: " option

case $option in
1) lock_user;;
2) unlock_user;;
3) show_locked_users;;
4) install_traffic_script;;
5) show_traffic_for_date;;
6) show_full_traffic_data;;  # This is the new option
7) exit;;
*) echo "Invalid option. Please try again.";;
esac
